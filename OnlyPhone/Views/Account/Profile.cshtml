@model OnlyPhone.Models.UserProfileViewModel
@{
    ViewBag.Title = "Thông tin cá nhân";
    Layout = null;
}

<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>@ViewBag.Title</title>
    <link href="~/Content/Css/profile.css" rel="stylesheet" />
    <link href="~/Content/FontAwesome/css/all.min.css" rel="stylesheet" />
   
</head>
<body>
    <div class="container">
        <!-- Profile Card -->
        <div class="profile-card">
            <header>
                <div class="avatar-wrap" id="avatarWrap" title="Avatar người dùng">
                    <img id="avatarImg" class="avatar" src="@Url.Content(Model.AvatarPath)" alt="avatar">
                    <div class="avatar-overlay" id="avatarOverlay">
                        <i class="fas fa-camera"></i>
                        <span>Thay đổi ảnh</span>
                    </div>
                </div>
            </header>

            <main class="card" role="main" aria-labelledby="profileTitle">
                <div class="card-inner">
                    <h2 id="profileTitle" style="margin:0 0 8px 0;">Thông tin cá nhân</h2>

                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> @TempData["SuccessMessage"]
                        </div>
                    }

                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-error">
                            <i class="fas fa-exclamation-circle"></i> @TempData["ErrorMessage"]
                        </div>
                    }

                    <form id="profileForm" method="post" action="@Url.Action("EditProfile", "Account")" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        <input type="hidden" id="userId" name="UserId" value="@Model.UserId" />
                        <input type="hidden" id="currentAvatar" value="@Model.AvatarUrl" />

                        <div class="row">
                            <label for="fullName">Họ và tên <span class="required">*</span></label>
                            <input id="fullName" name="FullName" type="text" class="value" value="@Model.FullName" aria-label="Họ tên" readonly required>
                        </div>

                        <div class="row">
                            <label for="email">Email</label>
                            <input id="email" type="email" class="value" value="@Model.Email" aria-label="Email" readonly disabled>
                        </div>

                        <div class="row">
                            <label for="phone">Số điện thoại <span class="required">*</span></label>
                            <input id="phone" name="PhoneNumber" type="text" class="value" value="@Model.PhoneNumber" aria-label="Số điện thoại" readonly required>
                        </div>

                        <div style="margin-bottom:1rem;">
                            <label style="display:block; margin-bottom:10px;">Địa chỉ</label>
                            <div class="address-grid">
                                <div>
                                    <select id="province" name="Province" aria-label="Tỉnh / Thành phố" disabled>
                                        <option value="">Chọn tỉnh / thành phố</option>
                                    </select>
                                </div>
                                <div>
                                    <input id="ward" name="Ward" type="text" class="value" value="@Model.Ward" placeholder="Nhập phường / xã" aria-label="Phường / Xã" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="row" style="margin-bottom:0.5rem">
                            <label for="addressDetail">Địa chỉ chi tiết</label>
                            <input id="addressDetail" name="AddressDetail" type="text" class="value" value="@Model.AddressDetail" placeholder="Số nhà, tên đường..." readonly>
                        </div>

                        <div class="row" style="margin-bottom:0.5rem">
                            <label>Ngày tạo tài khoản</label>
                            <div style="flex:1;">
                                <div class="meta" id="createdAt">@(Model.CreatedDate?.ToString("dd/MM/yyyy HH:mm") ?? "Chưa cập nhật")</div>
                            </div>
                        </div>

                        <div class="row" style="margin-bottom:0.5rem">
                            <label>Cập nhật lần cuối</label>
                            <div style="flex:1;">
                                <div class="meta" id="lastModified">@(Model.LastModified?.ToString("dd/MM/yyyy HH:mm") ?? "Chưa cập nhật")</div>
                            </div>
                        </div>

                        <div class="row" style="margin-top:6px;">
                            <label></label>
                            <div style="display:flex;flex-direction:column;gap:8px;">
                                <div class="small">Bạn có thể thay đổi avatar khi ở chế độ chỉnh sửa.</div>
                                <div style="display:flex;gap:10px;">
                                    <input id="avatarInput" name="AvatarFile" type="file" accept="image/jpeg,image/png,image/jpg,image/gif" style="display:none">
                                    <button class="btn" id="changeBtn" type="button" disabled>
                                        <i class="fas fa-camera"></i> Thay đổi avatar
                                    </button>
                                    <button class="btn ghost" id="resetBtn" type="button" disabled>
                                        <i class="fas fa-undo"></i> Khôi phục
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="actions" style="margin-top:6px;">
                            <a href="@Url.Action("Index", "Home")" class="btn ghost" style="text-decoration:none;">
                                <i class="fas fa-home"></i> Trang chủ
                            </a>
                            <button class="btn ghost" id="editBtn" type="button">
                                <i class="fas fa-edit"></i> Sửa
                            </button>
                            <button class="btn" id="saveBtn" type="submit" disabled>
                                <i class="fas fa-save"></i> Lưu
                            </button>
                            <a href="@Url.Action("ChangePassword", "Account")" class="btn ghost">
                                <i class="fas fa-key"></i> Đổi mật khẩu
                            </a>
                        </div>
                    </form>
                </div>
            </main>
        </div>

        <!-- Orders Section -->
        <div class="orders-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-box"></i>
                    Đơn hàng gần đây
                </h2>
                <a href="@Url.Action("OrderHistory", "Account")" class="btn-view-all">
                    <span>Xem tất cả</span>
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>

            <div id="ordersContainer" class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Đang tải đơn hàng...</p>
            </div>
        </div>
    </div>

    <script src="~/Scripts/Bootstrap/jquery-3.7.0.min.js"></script>
    <script>
    const initialData = {
        fullName: '@Html.Raw(Model.FullName)',
    phone: '@Html.Raw(Model.PhoneNumber)',
    province: '@Html.Raw(Model.Province ?? "")',
    ward: '@Html.Raw(Model.Ward ?? "")',
    addressDetail: '@Html.Raw(Model.AddressDetail ?? "")',
    avatarSrc: '@Url.Content(Model.AvatarPath)'
    };

    // Danh sách tỉnh/thành phố Việt Nam
    const provinces = [
    "Hà Nội", "TP. Hồ Chí Minh", "Đà Nẵng", "Hải Phòng", "Cần Thơ",
    "An Giang", "Bà Rịa - Vũng Tàu", "Bắc Giang", "Bắc Kạn", "Bạc Liêu",
    "Bắc Ninh", "Bến Tre", "Bình Định", "Bình Dương", "Bình Phước",
    "Bình Thuận", "Cà Mau", "Cao Bằng", "Đắk Lắk", "Đắk Nông",
    "Điện Biên", "Đồng Nai", "Đồng Tháp", "Gia Lai", "Hà Giang",
    "Hà Nam", "Hà Tĩnh", "Hải Dương", "Hậu Giang", "Hòa Bình",
    "Hưng Yên", "Khánh Hòa", "Kiên Giang", "Kon Tum", "Lai Châu",
    "Lâm Đồng", "Lạng Sơn", "Lào Cai", "Long An", "Nam Định",
    "Nghệ An", "Ninh Bình", "Ninh Thuận", "Phú Thọ", "Phú Yên",
    "Quảng Bình", "Quảng Nam", "Quảng Ngãi", "Quảng Ninh", "Quảng Trị",
    "Sóc Trăng", "Sơn La", "Tây Ninh", "Thái Bình", "Thái Nguyên",
    "Thanh Hóa", "Thừa Thiên Huế", "Tiền Giang", "Trà Vinh", "Tuyên Quang",
    "Vĩnh Long", "Vĩnh Phúc", "Yên Bái"
    ];

    const $province = document.getElementById('province');
    const $ward = document.getElementById('ward');
    const $addressDetail = document.getElementById('addressDetail');
    const avatarImg = document.getElementById('avatarImg');
    const avatarInput = document.getElementById('avatarInput');
    const avatarWrap = document.getElementById('avatarWrap');
    const avatarOverlay = document.getElementById('avatarOverlay');
    const changeBtn = document.getElementById('changeBtn');
    const resetBtn = document.getElementById('resetBtn');
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    const homebtn = document.getElementById('homebtn');
    let editing = false;
    let originalData = { };


    // Populate provinces
    function populateProvinces() {
        provinces.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = p;
            $province.appendChild(opt);
        });

    // Set initial value
    if (initialData.province) {
        $province.value = initialData.province;
        }
    }

    // Initialize
    populateProvinces();
    $ward.value = initialData.ward || '';

    function snapshotOriginal() {
        originalData = {
            name: document.getElementById('fullName').value,
            phone: document.getElementById('phone').value,
            province: $province.value,
            ward: $ward.value,
            addressDetail: $addressDetail.value,
            avatarSrc: avatarImg.src
        };
    }

    function setEditable(state) {
        editing = !!state;
    document.getElementById('fullName').readOnly = !editing;
    document.getElementById('phone').readOnly = !editing;
    $province.disabled = !editing;
    $ward.readOnly = !editing;
    $addressDetail.readOnly = !editing;
    changeBtn.disabled = !editing;
    resetBtn.disabled = !editing;
    saveBtn.disabled = !editing;
    editBtn.innerHTML = editing ? '<i class="fas fa-times"></i> Hủy' : '<i class="fas fa-edit"></i> Sửa';

    if (editing) {
        avatarWrap.classList.add('editable');
        } else {
        avatarWrap.classList.remove('editable');
        }
    }

    // Initialize
    snapshotOriginal();
    setEditable(false);

    // Edit/Cancel button
    editBtn.addEventListener('click', () => {
        if (!editing) {
        snapshotOriginal();
    setEditable(true);
        } else {
        // Cancel - restore original values
        document.getElementById('fullName').value = originalData.name;
    document.getElementById('phone').value = originalData.phone;
    $province.value = originalData.province || '';
    $ward.value = originalData.ward || '';
    $addressDetail.value = originalData.addressDetail || '';
    avatarImg.src = originalData.avatarSrc;
    avatarInput.value = '';
    setEditable(false);
        }
    });

    // Avatar change
    avatarInput.addEventListener('change', (e) => {
        if (!editing) return;
    const f = e.target.files && e.target.files[0];
    if (!f) return;

    console.log('File selected:', f.name, f.size, f.type);

        // Validate file size (5MB)
        if (f.size > 5 * 1024 * 1024) {
        alert('Kích thước file không được vượt quá 5MB');
    avatarInput.value = '';
    return;
        }

    // Validate file type
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
    if (!allowedTypes.includes(f.type)) {
        alert('Chỉ chấp nhận file ảnh (jpg, jpeg, png, gif)');
    avatarInput.value = '';
    return;
        }

    const url = URL.createObjectURL(f);
    avatarImg.src = url;
    console.log('Avatar updated with:', url);
    });

    changeBtn.addEventListener('click', (e) => {
        e.preventDefault();
    e.stopPropagation();
    console.log('Change button clicked, editing:', editing);
    if (!editing) {
        console.log('Not in editing mode, ignoring click');
    return;
        }
    console.log('Triggering file input click');
    avatarInput.click();
    });

    resetBtn.addEventListener('click', (e) => {
        e.preventDefault();
    e.stopPropagation();
    console.log('Reset button clicked');
    if (!editing) return;
    avatarImg.src = originalData.avatarSrc;
    avatarInput.value = '';
    console.log('Avatar reset to:', originalData.avatarSrc);
    });

    // Drag & drop avatar
    ['dragenter', 'dragover'].forEach(evt => {
        avatarWrap.addEventListener(evt, e => {
            if (!editing) return;
            e.preventDefault();
            avatarWrap.style.opacity = 0.9;
        });
    });

    ['dragleave', 'drop'].forEach(evt => {
        avatarWrap.addEventListener(evt, e => {
            if (!editing) return;
            e.preventDefault();
            avatarWrap.style.opacity = 1;
        });
    });

    avatarWrap.addEventListener('drop', e => {
        if (!editing) return;
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (!f) return;

        // Validate
        if (f.size > 5 * 1024 * 1024) {
        alert('Kích thước file không được vượt quá 5MB');
    return;
        }

    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
    if (!allowedTypes.includes(f.type)) {
        alert('Chỉ chấp nhận file ảnh (jpg, jpeg, png, gif)');
    return;
        }

    // Create a DataTransfer to set files
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(f);
    avatarInput.files = dataTransfer.files;

    avatarImg.src = URL.createObjectURL(f);
    });

    // Click on avatar to change (when editing)
    avatarWrap.addEventListener('click', () => {
        if (editing) {
        avatarInput.click();
        }
    });

    // Form validation before submit
    document.getElementById('profileForm').addEventListener('submit', function(e) {
        const fullName = document.getElementById('fullName').value.trim();
    const phone = document.getElementById('phone').value.trim();

    if (!fullName) {
        e.preventDefault();
    alert('Vui lòng nhập họ và tên');
    return false;
        }

    if (!phone) {
        e.preventDefault();
    alert('Vui lòng nhập số điện thoại');
    return false;
        }

    // Validate phone format
    const phoneRegex = /^(0[3|5|7|8|9])+([0-9]{8})$/;
    if (!phoneRegex.test(phone)) {
        e.preventDefault();
    alert('Số điện thoại không hợp lệ (vd: 0912345678)');
    return false;
        }

    // Show loading
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';

    return true;
    });

    // Auto-hide alerts after 5 seconds
    setTimeout(() => {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
        alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 300);
        });
    }, 5000);

    // Load recent orders using Fetch API
    document.addEventListener('DOMContentLoaded', function() {
        loadRecentOrders();
    });

    async function loadRecentOrders() {
        try {
            // Gọi API sử dụng fetch
            const response = await fetch('@Url.Action("GetRecentOrders", "Account")', {
        method: 'GET',
    headers: {
        'Content-Type': 'application/json'
                }
            });

    // Kiểm tra nếu server trả về lỗi (vd: 404, 500)
    if (!response.ok) {
                throw new Error('Network response was not ok');
            }

    // Chuyển đổi dữ liệu nhận được sang JSON
    const result = await response.json();

    // Logic xử lý dữ liệu giống hệt code cũ
    if (result.success) {
        displayOrders(result.data);
            } else {
        showEmptyOrders();
            }
        } catch (error) {
        // Xử lý khi có lỗi mạng hoặc lỗi server
        console.error('Error loading orders:', error);
    showEmptyOrders();
        }
    }

    function displayOrders(orders) {
        if (!orders || orders.length === 0) {
        showEmptyOrders();
    return;
        }

    let html = '<div class="orders-list">';
        orders.forEach(function(order) {
            html += `
                <div class="order-item" onclick="window.location.href='@Url.Action("OrderDetail", "Account")?id=${order.orderId}'">
                    <div class="order-header">
                        <span class="order-id">
                            <i class="fas fa-hashtag"></i> ${order.orderId}
                        </span>
                        <span class="order-status" style="background-color: ${getStatusColor(order.statusName)}">
                            ${order.statusName}
                        </span>
                    </div>
                    <div class="order-body">
                        <div>
                            <i class="fas fa-calendar"></i> ${formatDate(order.orderDate)}
                        </div>
                        <div>
                            <i class="fas fa-box"></i> ${order.itemCount} sản phẩm
                        </div>
                        <div class="order-total">
                            ${formatCurrency(order.totalAmount)}
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';

    // Vẫn dùng jQuery để render HTML cho tiện (vì dự án bạn đang có sẵn jQuery)
    $('#ordersContainer').html(html);
    }

    function showEmptyOrders() {
        $('#ordersContainer').html(`
            <div class="empty-orders">
                <i class="fas fa-box-open"></i>
                <p>Bạn chưa có đơn hàng nào</p>
                <a href="@Url.Action("Index", "Home")" class="btn">
                    <i class="fas fa-shopping-bag"></i> Mua sắm ngay
                </a>
            </div>
        `);
    }

    function getStatusColor(statusName) {
        if (!statusName) return '#6B7280'; // Xử lý null safety

    if (statusName.includes('Chờ') || statusName.includes('Pending'))
    return '#FFA500';
    if (statusName.includes('Xử lý') || statusName.includes('Processing'))
    return '#3B82F6';
    if (statusName.includes('Xác nhận') || statusName.includes('Confirmed'))
    return '#10B981';
    if (statusName.includes('Đang giao') || statusName.includes('Shipping'))
    return '#8B4513';
    if (statusName.includes('Hoàn thành') || statusName.includes('Delivered'))
    return '#22C55E';
    if (statusName.includes('Hủy') || statusName.includes('Cancelled'))
    return '#EF4444';
    return '#6B7280';
    }

    function formatDate(dateString) {
        if (!dateString) return '';
    const date = new Date(dateString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
    currency: 'VND'
        }).format(amount);
    }
    </script>
    <script src="~/Scripts/CustomJS/Pinglogin.js"></script>
</body>
</html>