@model List<OnlyPhone.Areas.Admin.Data.OrderListViewModel>
@{
    ViewBag.Title = "Quản lý đơn hàng";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
    var statusList = ViewBag.StatusList as List<OnlyPhone.Models.OrderStatus>;
}

<style>
    /* ======================== */
    /* 1. GLOBAL VARIABLES      */
    /* ======================== */
    :root {
        --border-color: rgba(0,0,0,0.08);
        --bg-gray: #f8fafc;
        --card-radius: 12px;
    }
    body.dark {
        --border-color: rgba(255,255,255,0.1);
        --bg-gray: #0f1724;
    }

    /* ======================== */
    /* 2. TOP STATS CARDS       */
    /* ======================== */
    .stats-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }

    .stat-card {
        background: var(--panel);
        border: 1px solid var(--border-color);
        border-radius: var(--card-radius);
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 120px;
        transition: transform 0.2s;
        box-shadow: var(--shadow);
        color: var(--text);
        position: relative; /* [FIX] Quan trọng để icon neo đúng chỗ */
        overflow: hidden;
    }
    .stat-card:hover { transform: translateY(-3px); border-color: var(--accent); }

    .stat-title { font-size: 13px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-size: 28px; font-weight: 800; margin-top: auto; color: var(--text); line-height: 1; }

    /* Icon định vị tuyệt đối trong card */
    .icon-box {
        width: 40px; height: 40px;
        border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-size: 18px;
        position: absolute;
        top: 15px; right: 15px; /* [FIX] Neo góc phải trên */
    }

    .card-all .icon-box { background: rgba(59,130,246,0.1); color: #3b82f6; }
    .card-pending .icon-box { background: rgba(245,158,11,0.1); color: #f59e0b; }
    .card-cancel .icon-box { background: rgba(239,68,68,0.1); color: #ef4444; }
    .card-done .icon-box { background: rgba(16,185,129,0.1); color: #10b981; }

    /* ======================== */
    /* 3. CONTROL PANEL         */
    /* ======================== */
    .control-panel {
        background: var(--panel); padding: 15px;
        border-radius: var(--card-radius);
        border: 1px solid var(--border-color);
        display: flex; align-items: center; justify-content: space-between;
        margin-bottom: 20px; box-shadow: var(--shadow);
        color: var(--text); gap: 15px; flex-wrap: wrap;
    }
    .cp-left { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; flex: 1; }
    .cp-title { font-size: 18px; font-weight: 700; margin-right: 15px; white-space: nowrap; }

    .form-control-sm, .form-select-sm {
        background: var(--bg); border: 1px solid var(--border-color);
        color: var(--text); border-radius: 8px; height: 40px;
        padding: 0 12px; outline: none; font-size: 13px;
    }
    .form-control-sm:focus { border-color: var(--accent); background: var(--panel); }

    .btn-filter {
        background: var(--panel); border: 1px solid var(--border-color);
        color: var(--text); padding: 0 15px; height: 40px;
        border-radius: 8px; cursor: pointer; font-size: 13px;
        display: flex; align-items: center; gap: 8px; transition: all 0.2s;
        font-weight: 500;
    }
    .btn-filter:hover { border-color: var(--accent); color: var(--accent); }

    /* [FIX] Date Popup đẹp hơn */
    .date-popup {
        position: absolute; top: calc(100% + 10px); right: 0; /* Neo bên phải để không tràn */
        background: var(--panel); border: 1px solid var(--border-color);
        padding: 20px; border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        display: none; z-index: 1000; width: 320px;
        animation: slideDown 0.2s ease-out;
    }
    .date-popup.show { display: block; }
    .date-row { display: flex; gap: 15px; margin-bottom: 15px; }
    .date-group { flex: 1; }
    .date-group label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 5px; font-weight: 600; }

    /* Search Box */
    .search-box input { padding-right: 40px; }
    .search-box button {
        position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
        width: 30px; height: 30px; border-radius: 6px;
        background: transparent; border: none; color: var(--muted); cursor: pointer;
    }
    .search-box button:hover { background: var(--bg-gray); color: var(--accent); }

    /* ======================== */
    /* 4. ORDERS CONTAINER      */
    /* ======================== */
    .orders-container {
        display: flex; flex-direction: column; gap: 15px;
        max-height: calc(100vh - 320px); overflow-y: auto; padding-bottom: 20px;
    }
    .orders-container::-webkit-scrollbar { width: 6px; }
    .orders-container::-webkit-scrollbar-thumb { background: var(--muted); border-radius: 3px; opacity: 0.5; }

    /* ORDER CARD */
    .order-card {
        background: var(--panel); border: 1px solid var(--border-color);
        border-radius: 12px; padding: 20px;
        display: flex; flex-direction: column;
        transition: all 0.2s; position: relative; box-shadow: var(--shadow);
    }
    .order-card:hover { border-color: var(--accent); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }

    .order-summary { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px; }

    /* Columns */
    .ord-left { min-width: 180px; }
    .ord-id { font-weight: 800; font-size: 16px; color: var(--text); margin-bottom: 4px; }
    .ord-date { font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 6px; }

    .ord-mid { flex: 1; display: flex; gap: 40px; justify-content: center; align-items: center; }
    .ord-stat-item { display: flex; flex-direction: column; align-items: center; }
    .ord-label { font-size: 11px; color: var(--muted); text-transform: uppercase; font-weight: 700; margin-bottom: 2px; }
    .ord-val { font-weight: 600; font-size: 15px; color: var(--text); }
    .ord-price { color: #3b82f6; font-weight: 800; font-size: 16px; }

    .ord-right { display: flex; align-items: center; gap: 12px; }

    /* Badge Status */
    .badge-stt { padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .stt-1 { background: #fff7ed; color: #ea580c; border: 1px solid #ffedd5; } /* Chờ */
    .stt-2 { background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; } /* Đã xác nhận */
    .stt-3 { background: #faf5ff; color: #7c3aed; border: 1px solid #ede9fe; } /* Chuẩn bị */
    .stt-4 { background: #f0f9ff; color: #0ea5e9; border: 1px solid #e0f2fe; } /* Vận chuyển */
    .stt-5 { background: #f0fdf4; color: #166534; border: 1px solid #dcfce7; } /* Thành công */
    .stt-6 { background: #fef2f2; color: #dc2626; border: 1px solid #fee2e2; } /* Hủy */

    /* Buttons */
    .btn-action {
        padding: 8px 16px; border-radius: 8px; font-size: 13px;
        font-weight: 600; cursor: pointer; border: none;
        transition: all 0.2s; white-space: nowrap;
        display: inline-flex; align-items: center; gap: 6px;
    }
    .btn-detail { background: var(--bg); border: 1px solid var(--border-color); color: var(--text); }
    .btn-detail:hover, .btn-detail.active { background: var(--accent); color: white; border-color: var(--accent); }
    .btn-next { background: var(--positive); color: white; box-shadow: 0 2px 10px rgba(16,185,129,0.3); }
    .btn-next:hover { transform: translateY(-1px); opacity: 0.9; }
    .btn-cancel { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
    .btn-cancel:hover { background: var(--danger); color: white; }

    /* ======================== */
    /* 5. DETAIL PANEL          */
    /* ======================== */
    .detail-panel {
        margin-top: 20px; border-top: 1px dashed var(--border-color);
        padding-top: 20px; display: none;
        animation: slideDown 0.3s ease;
    }
    @@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .detail-grid { display: grid; grid-template-columns: 1fr 380px; gap: 25px; }

    /* PRODUCT ITEM - [FIX] Layout cho nút X */
    .prod-item {
        display: flex; align-items: center; gap: 15px;
        padding: 12px; border: 1px solid var(--border-color);
        background: var(--bg-gray); border-radius: 10px; margin-bottom: 10px;
        transition: all 0.2s;
    }
    .prod-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; background: #fff; border: 1px solid var(--border-color); }
    .prod-info { flex: 1; }
    .prod-name { font-size: 14px; font-weight: 600; color: var(--text); display: block; margin-bottom: 4px; }
    .prod-meta { font-size: 12px; color: var(--muted); }

    /* Giá tiền và Nút Xóa nằm chung 1 container bên phải */
    .prod-right-side {
        display: flex; align-items: center; gap: 15px;
    }
    .prod-total { font-weight: 700; color: #3b82f6; font-size: 14px; white-space: nowrap; }

    /* Nút X - Mặc định ẩn */
    .btn-remove-prod {
        width: 30px; height: 30px; border-radius: 50%;
        background: #fee2e2; color: #dc2626; border: none;
        display: none; /* Ẩn khi không sửa */
        align-items: center; justify-content: center;
        cursor: pointer; transition: all 0.2s; font-size: 14px;
    }
    .btn-remove-prod:hover { background: #dc2626; color: white; transform: rotate(90deg); }

    /* Hiển thị nút X khi ở chế độ chỉnh sửa */
    .editing .btn-remove-prod { display: flex; }

    /* Customer Info Box */
    .customer-box { background: var(--bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); }
    .info-head { font-weight: 700; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; font-size: 15px; display: flex; justify-content: space-between; }
    .info-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 13px; }
    .info-label { color: var(--muted); }
    .info-val { color: var(--text); font-weight: 500; text-align: right; max-width: 60%; }

    .total-row { margin-top: 20px; padding-top: 15px; border-top: 2px dashed var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .total-label { font-weight: 700; font-size: 14px; }
    .total-val { font-weight: 800; font-size: 20px; color: #ef4444; }

    /* Edit Actions */
    .edit-actions { display: none; justify-content: flex-end; gap: 10px; margin-top: 15px; }
    .editing .edit-actions { display: flex; }
    .editing .btn-edit-trigger { display: none; }

    /* Responsive */
    @@media (max-width: 992px) {
        .stats-container { grid-template-columns: 1fr 1fr; }
        .detail-grid { grid-template-columns: 1fr; }
    }
    @@media (max-width: 768px) {
        .order-summary { flex-direction: column; align-items: flex-start; gap: 15px; }
        .ord-mid { width: 100%; justify-content: space-between; border-top: 1px dashed var(--border-color); border-bottom: 1px dashed var(--border-color); padding: 15px 0; margin: 5px 0; }
        .ord-right { width: 100%; justify-content: space-between; }
        .stats-container { grid-template-columns: 1fr; }
        .control-panel { padding: 15px; }
        .cp-left { width: 100%; }
        .search-box { width: 100%; max-width: none; }
        .date-popup { width: 280px; }
    }
</style>

<div class="stats-container">
    <div class="stat-card card-all">
        <div class="stat-title">Tổng đơn hàng</div>
        <div class="stat-value">@ViewBag.TotalOrders</div>
        <div class="icon-box"><i class="fa fa-file-invoice"></i></div>
    </div>
    <div class="stat-card card-pending">
        <div class="stat-title">Chờ xác nhận</div>
        <div class="stat-value">@ViewBag.TotalPending</div>
        <div class="icon-box"><i class="fa fa-clock"></i></div>
    </div>
    <div class="stat-card card-cancel">
        <div class="stat-title">Đơn hủy</div>
        <div class="stat-value">@ViewBag.TotalCancelled</div>
        <div class="icon-box"><i class="fa fa-times-circle"></i></div>
    </div>
    <div class="stat-card card-done">
        <div class="stat-title">Hoàn thành</div>
        <div class="stat-value">@ViewBag.TotalCompleted</div>
        <div class="icon-box"><i class="fa fa-check-circle"></i></div>
    </div>
</div>

<form method="get" action="@Url.Action("Index")" id="filterForm">
    <div class="control-panel">
        <div class="cp-left">
            <div class="cp-title">Danh sách đơn hàng</div>

            <select name="status" class="form-select-sm" style="width:160px;" onchange="this.form.submit()">
                <option value="">Tất cả trạng thái</option>
                @if (statusList != null)
                {
                    foreach (var s in statusList)
                    {
                        <option value="@s.StatusID" @(Request["status"] == s.StatusID.ToString() ? "selected" : "")>@s.StatusName</option>
                    }
                }
            </select>

            <div style="position:relative;">
                <button type="button" class="btn-filter" onclick="toggleDatePopup()">
                    <i class="fa fa-calendar-alt"></i>
                    @(string.IsNullOrEmpty(Request["from"]) ? "Chọn thời gian" : $"{Request["from"]} - {Request["to"]}")
                </button>

                <div class="date-popup" id="datePopup">
                    <h6 style="margin-bottom:15px;font-weight:700;color:var(--text)">Lọc theo ngày</h6>
                    <div class="date-row" style="display:flex;flex-direction:column;gap:10px;">
                        <div class="date-group">
                            <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:5px;">Từ ngày</label>
                            <input type="date" name="from" value="@Request["from"]" class="form-control-sm" style="width:100%">
                        </div>
                        <div class="date-group">
                            <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:5px;">Đến ngày</label>
                            <input type="date" name="to" value="@Request["to"]" class="form-control-sm" style="width:100%">
                        </div>
                    </div>
                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                        <button type="button" class="btn-cancel" onclick="toggleDatePopup()" style="border-radius:6px; padding:6px 12px; font-size:12px;">Hủy</button>
                        <button type="submit" class="btn-next" style="border:none; padding:6px 15px; border-radius:6px; font-size:12px; font-weight:600;">Áp dụng</button>
                    </div>
                </div>
            </div>

            <div class="search-box" style="position:relative; flex:1; max-width:320px;">
                <input type="text" name="keyword" value="@Request["keyword"]" class="form-control-sm" placeholder="Tìm mã đơn / User ID..." style="width:100%; padding-right:40px;">
                <button type="submit" style="position:absolute; right:5px; top:50%; transform:translateY(-50%); height:30px; width:30px; background:none; border:none; color:var(--muted); cursor:pointer; display:flex; align-items:center; justify-content:center;">
                    <i class="fa fa-search"></i>
                </button>
            </div>
        </div>
    </div>
</form>

<div class="orders-container">
    @foreach (var item in Model)
    {
        string badgeClass = "stt-" + item.StatusId;
        string nextAction = "";
        int nextStatusId = 0;

        // Logic nút hành động tiếp theo
        switch (item.StatusId)
        {
            case 1: nextAction = "Xác nhận đơn"; nextStatusId = 2; break;
            case 2: nextAction = "Soạn xong"; nextStatusId = 3; break;
            case 3: nextAction = "Vận chuyển"; nextStatusId = 4; break;
            case 4: nextAction = "Đã giao"; nextStatusId = 5; break;
        }

        <div class="order-card" id="order-@item.OrderId">
            <div class="order-summary">
                <div class="ord-left">
                    <div class="ord-id">#@item.OrderId</div>
                    <div class="ord-date"><i class="fa fa-clock"></i> @item.OrderDate.ToString("dd/MM/yyyy HH:mm")</div>
                </div>

                <div class="ord-mid">
                    <div class="ord-stat-item">
                        <span class="ord-label">SẢN PHẨM</span>
                        <span class="ord-val">@item.Items.Sum(x => x.Quantity)</span>
                    </div>
                    <div class="ord-stat-item">
                        <span class="ord-label">THÀNH TIỀN</span>
                        <span class="ord-price">@string.Format("{0:N0}đ", item.TotalAmount)</span>
                    </div>
                </div>

                <div class="ord-right">
                    <span class="badge-stt @badgeClass">@item.StatusName</span>

                    <button class="btn-action btn-detail" onclick="toggleDetail('@item.OrderId')">
                        <i class="fa fa-angle-down"></i> Chi tiết
                    </button>

                    @if (!string.IsNullOrEmpty(nextAction))
                    {
                        <button class="btn-action btn-next" onclick="updateStatus('@item.OrderId', @nextStatusId)">
                            <i class="fa fa-check"></i> @nextAction
                        </button>
                    }

                    @if (item.StatusId <= 2)
                    {
                        <button class="btn-action btn-cancel" onclick="updateStatus('@item.OrderId', 6)">Hủy</button>
                    }
                </div>
            </div>

            <div class="detail-panel" id="detail-@item.OrderId">
                <div class="detail-grid">
                    <div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h6 style="font-weight:700; margin:0; color:var(--text)">Danh sách sản phẩm</h6>
                            @if (item.StatusId <= 2)
                            {
                                <button class="btn-action btn-detail btn-edit-trigger" style="padding:6px 12px;" onclick="enableEdit('@item.OrderId')">
                                    <i class="fa fa-pen"></i> Chỉnh sửa
                                </button>
                            }
                        </div>

                        @foreach (var prod in item.Items)
                        {
                            <div class="prod-item" id="item-@item.OrderId-@prod.ProductId">
                                <img src="@Url.Content($"~/Content/Pic/images/{prod.ProductImage}")" class="prod-img" onerror="this.src='https://via.placeholder.com/50'">
                                <div class="prod-info">
                                    <span class="prod-name">@prod.ProductName</span>
                                    <div class="prod-meta">Đơn giá: @string.Format("{0:N0}đ", prod.Price)</div>
                                </div>

                                <div class="prod-right-side">
                                    <div style="text-align:right;">
                                        <div style="font-size:12px; color:var(--muted)">x @prod.Quantity</div>
                                        <div class="prod-total">@string.Format("{0:N0}đ", prod.Total)</div>
                                    </div>
                                    <button class="btn-remove-prod" onclick="removeProduct('@item.OrderId', @prod.ProductId)" title="Xóa sản phẩm">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        }

                        <div class="edit-actions">
                            <button class="btn-action btn-cancel" onclick="cancelEdit('@item.OrderId')">Hủy bỏ</button>
                            <button class="btn-action btn-next" onclick="location.reload()">Hoàn tất</button>
                        </div>
                    </div>

                    <div class="customer-box">
                        <div class="info-head">
                            <span>Thông tin đơn hàng</span>
                            <i class="fa fa-info-circle" style="color:var(--accent)"></i>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Người đặt</span>
                            <span class="info-val">
                                <div>@item.UserName (ID: @item.UserId)</div>
                                <div style="font-size:11px;color:var(--muted);margin-top:2px;">@item.UserPhone</div>
                            </span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Thanh toán</span>
                            <span class="info-val">@item.PaymentMethod <span style="color:var(--positive)">(@item.PaymentStatus)</span></span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Voucher</span>
                            <span class="info-val">@item.VoucherCode</span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Phí vận chuyển</span>
                            <span class="info-val">@string.Format("{0:N0}đ", item.ShippingFee)</span>
                        </div>

                        <div class="total-row">
                            <span class="total-label">TỔNG CỘNG</span>
                            <span class="total-val">@string.Format("{0:N0}đ", item.TotalAmount)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // 1. Date Popup Logic
        function toggleDatePopup() {
            const popup = document.getElementById('datePopup');
            if (popup.classList.contains('show')) {
                popup.classList.remove('show');
            } else {
                popup.classList.add('show');
            }
        }

        // Close popup on outside click
        window.addEventListener('click', function (e) {
            const popup = document.getElementById('datePopup');
            const btn = document.querySelector('.btn-filter');
            if (popup && btn && !popup.contains(e.target) && !btn.contains(e.target)) {
                popup.classList.remove('show');
            }
        });

        // 2. Toggle Detail Logic
        function toggleDetail(id) {
            const card = document.getElementById(`order-${id}`);
            // Nếu đang sửa thì không cho đóng
            if (card.classList.contains('editing')) return;

            const panel = document.getElementById(`detail-${id}`);
            const btnIcon = card.querySelector('.btn-detail i');

            if (panel.style.display === "block") {
                panel.style.display = "none";
                btnIcon.className = "fa fa-angle-down";
                card.querySelector('.btn-detail').classList.remove('active');
            } else {
                // Đóng các panel khác cho gọn
                document.querySelectorAll('.detail-panel').forEach(p => p.style.display = 'none');
                document.querySelectorAll('.btn-detail').forEach(b => {
                    b.classList.remove('active');
                    b.querySelector('i').className = "fa fa-angle-down";
                });

                panel.style.display = "block";
                btnIcon.className = "fa fa-angle-up";
                card.querySelector('.btn-detail').classList.add('active');
            }
        }

        // 3. Edit Mode Logic
        function enableEdit(id) {
            const card = document.getElementById(`order-${id}`);
            card.classList.add('editing');
        }

        function cancelEdit(id) {
            const card = document.getElementById(`order-${id}`);
            card.classList.remove('editing');
        }

        // 4. Update Status AJAX
        function updateStatus(id, status) {
            const msg = status === 6 ? 'Bạn có chắc muốn HỦY đơn hàng này?' : 'Cập nhật trạng thái đơn hàng?';
            if (!confirm(msg)) return;

            fetch('/Admin/Orders/UpdateStatus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orderId: id, newStatus: status })
            })
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        alert("Cập nhật thành công!");
                        location.reload();
                    } else {
                        alert("Lỗi cập nhật!");
                    }
                })
                .catch(e => alert("Lỗi kết nối server"));
        }

        // 5. Remove Product AJAX
        function removeProduct(orderId, productId) {
            if (!confirm('Xóa sản phẩm này khỏi đơn hàng? Tổng tiền sẽ được tính lại.')) return;

            fetch('/Admin/Orders/RemoveProduct', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orderId: orderId, productId: productId })
            })
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        // Xóa visual ngay lập tức
                        document.getElementById(`item-${orderId}-${productId}`).remove();
                    } else {
                        alert("Không thể xóa sản phẩm cuối cùng!");
                    }
                });
        }
    </script>
}