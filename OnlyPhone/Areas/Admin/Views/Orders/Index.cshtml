@model List<OnlyPhone.Areas.Admin.Data.OrderListViewModel>
@{
    ViewBag.Title = "Quản lý đơn hàng";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
    var statusList = ViewBag.StatusList as List<OnlyPhone.Models.OrderStatus>;
}
<link href="~/Content/Css/admin/Ordermanager.css" rel="stylesheet" />


<div class="stats-container">
    <div class="stat-card card-all">
        <div class="stat-title">Tổng đơn hàng</div>
        <div class="stat-value">@ViewBag.TotalOrders</div>
        <div class="icon-box"><i class="fa fa-file-invoice"></i></div>
    </div>
    <div class="stat-card card-pending">
        <div class="stat-title">Chờ xác nhận</div>
        <div class="stat-value">@ViewBag.TotalPending</div>
        <div class="icon-box"><i class="fa fa-clock"></i></div>
    </div>
    <div class="stat-card card-cancel">
        <div class="stat-title">Đơn hủy</div>
        <div class="stat-value">@ViewBag.TotalCancelled</div>
        <div class="icon-box"><i class="fa fa-times-circle"></i></div>
    </div>
    <div class="stat-card card-done">
        <div class="stat-title">Hoàn thành</div>
        <div class="stat-value">@ViewBag.TotalCompleted</div>
        <div class="icon-box"><i class="fa fa-check-circle"></i></div>
    </div>
</div>

<form method="get" action="@Url.Action("Index")" id="filterForm">
    <div class="control-panel">
        <div class="cp-left">
            <div class="cp-title">Danh sách đơn hàng</div>

            <select name="status" class="form-select-sm" style="width:160px;" onchange="this.form.submit()">
                <option value="">Tất cả trạng thái</option>
                @if (statusList != null)
                {
                    foreach (var s in statusList)
                    {
                        <option value="@s.StatusID" @(Request["status"] == s.StatusID.ToString() ? "selected" : "")>@s.StatusName</option>
                    }
                }
            </select>

            <div style="position:relative;">
                <button type="button" class="btn-filter" onclick="toggleDatePopup()">
                    <i class="fa fa-calendar-alt"></i>
                    @(string.IsNullOrEmpty(Request["from"]) ? "Chọn thời gian" : $"{Request["from"]} - {Request["to"]}")
                </button>

                <div class="date-popup" id="datePopup">
                    <h6 style="margin-bottom:15px;font-weight:700;color:var(--text)">Lọc theo ngày</h6>
                    <div class="date-row" style="display:flex;flex-direction:column;gap:10px;">
                        <div class="date-group">
                            <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:5px;">Từ ngày</label>
                            <input type="date" name="from" value="@Request["from"]" class="form-control-sm" style="width:100%">
                        </div>
                        <div class="date-group">
                            <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:5px;">Đến ngày</label>
                            <input type="date" name="to" value="@Request["to"]" class="form-control-sm" style="width:100%">
                        </div>
                    </div>
                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                        <button type="button" class="btn-cancel" onclick="toggleDatePopup()" style="border-radius:6px; padding:6px 12px; font-size:12px;">Hủy</button>
                        <button type="submit" class="btn-next" style="border:none; padding:6px 15px; border-radius:6px; font-size:12px; font-weight:600;">Áp dụng</button>
                    </div>
                </div>
            </div>

            <div class="search-box" style="position:relative; flex:1; max-width:320px;">
                <input type="text" name="keyword" value="@Request["keyword"]" class="form-control-sm" placeholder="Tìm mã đơn / User ID..." style="width:100%; padding-right:40px;">
                <button type="submit" style="position:absolute; right:5px; top:50%; transform:translateY(-50%); height:30px; width:30px; background:none; border:none; color:var(--muted); cursor:pointer; display:flex; align-items:center; justify-content:center;">
                    <i class="fa fa-search"></i>
                </button>
            </div>
        </div>
    </div>
</form>

<div class="orders-container">
    @foreach (var item in Model)
    {
        string badgeClass = "stt-" + item.StatusId;
        string nextAction = "";
        int nextStatusId = 0;

        // Logic nút hành động tiếp theo
        switch (item.StatusId)
        {
            case 1: nextAction = "Xác nhận đơn"; nextStatusId = 2; break;
            case 2: nextAction = "Soạn xong"; nextStatusId = 3; break;
            case 3: nextAction = "Vận chuyển"; nextStatusId = 4; break;
            case 4: nextAction = "Đã giao"; nextStatusId = 5; break;
        }

        <div class="order-card" id="order-@item.OrderId">
            <div class="order-summary">
                <div class="ord-left">
                    <div class="ord-id">#@item.OrderId</div>
                    <div class="ord-date"><i class="fa fa-clock"></i> @item.OrderDate.ToString("dd/MM/yyyy HH:mm")</div>
                </div>

                <div class="ord-mid">
                    <div class="ord-stat-item">
                        <span class="ord-label">SẢN PHẨM</span>
                        <span class="ord-val">@item.Items.Sum(x => x.Quantity)</span>
                    </div>
                    <div class="ord-stat-item">
                        <span class="ord-label">THÀNH TIỀN</span>
                        <span class="ord-price">@string.Format("{0:N0}đ", item.TotalAmount)</span>
                    </div>
                </div>

                <div class="ord-right">
                    <span class="badge-stt @badgeClass">@item.StatusName</span>

                    <button class="btn-action btn-detail" onclick="toggleDetail('@item.OrderId')">
                        <i class="fa fa-angle-down"></i> Chi tiết
                    </button>

                    @if (!string.IsNullOrEmpty(nextAction))
                    {
                        <button class="btn-action btn-next" onclick="updateStatus('@item.OrderId', @nextStatusId)">
                            <i class="fa fa-check"></i> @nextAction
                        </button>
                    }

                    @if (item.StatusId <= 2)
                    {
                        <button class="btn-action btn-cancel" onclick="updateStatus('@item.OrderId', 6)">Hủy</button>
                    }
                </div>
            </div>

            <div class="detail-panel" id="detail-@item.OrderId">
                <div class="detail-grid">
                    <div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h6 style="font-weight:700; margin:0; color:var(--text)">Danh sách sản phẩm</h6>
                            @if (item.StatusId <= 2)
                            {
                                <button class="btn-action btn-detail btn-edit-trigger" style="padding:6px 12px;" onclick="enableEdit('@item.OrderId')">
                                    <i class="fa fa-pen"></i> Chỉnh sửa
                                </button>
                            }
                        </div>

                        @foreach (var prod in item.Items)
                        {
                            <div class="prod-item" id="item-@item.OrderId-@prod.ProductId">
                                <img src="@Url.Content($"~/Content/Pic/images/{prod.ProductImage}")" class="prod-img" onerror="this.src='https://via.placeholder.com/50'">
                                <div class="prod-info">
                                    <span class="prod-name">@prod.ProductName</span>
                                    <div class="prod-meta">Đơn giá: @string.Format("{0:N0}đ", prod.Price)</div>
                                </div>

                                <div class="prod-right-side">
                                    <div style="text-align:right;">
                                        <div style="font-size:12px; color:var(--muted)">x @prod.Quantity</div>
                                        <div class="prod-total">@string.Format("{0:N0}đ", prod.Total)</div>
                                    </div>
                                    <button class="btn-remove-prod" onclick="removeProduct('@item.OrderId', @prod.ProductId)" title="Xóa sản phẩm">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        }

                        <div class="edit-actions">
                            <button class="btn-action btn-cancel" onclick="cancelEdit('@item.OrderId')">Hủy bỏ</button>
                            <button class="btn-action btn-next" onclick="location.reload()">Hoàn tất</button>
                        </div>
                    </div>

                    <div class="customer-box">
                        <div class="info-head">
                            <span>Thông tin đơn hàng</span>
                            <i class="fa fa-info-circle" style="color:var(--accent)"></i>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Người đặt</span>
                            <span class="info-val">
                                <div>@item.UserName (#@item.UserId)</div>
                                <div style="font-size:11px;color:var(--muted);margin-top:2px;">@item.UserPhone</div>
                            </span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Thanh toán</span>
                            <span class="info-val">@item.PaymentMethod <span style="color:var(--positive)">(@item.PaymentStatus)</span></span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Voucher</span>
                            <span class="info-val">@item.VoucherCode</span>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Phí vận chuyển</span>
                            <span class="info-val">@string.Format("{0:N0}đ", item.ShippingFee)</span>
                        </div>

                        <div class="total-row">
                            <span class="total-label">TỔNG CỘNG</span>
                            <span class="total-val">@string.Format("{0:N0}đ", item.TotalAmount)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // 1. Date Popup Logic
        function toggleDatePopup() {
            const popup = document.getElementById('datePopup');
            if (popup.classList.contains('show')) {
                popup.classList.remove('show');
            } else {
                popup.classList.add('show');
            }
        }

        // Close popup on outside click
        window.addEventListener('click', function (e) {
            const popup = document.getElementById('datePopup');
            const btn = document.querySelector('.btn-filter');
            if (popup && btn && !popup.contains(e.target) && !btn.contains(e.target)) {
                popup.classList.remove('show');
            }
        });

        // 2. Toggle Detail Logic
        function toggleDetail(id) {
            const card = document.getElementById(`order-${id}`);
            // Nếu đang sửa thì không cho đóng
            if (card.classList.contains('editing')) return;

            const panel = document.getElementById(`detail-${id}`);
            const btnIcon = card.querySelector('.btn-detail i');

            if (panel.style.display === "block") {
                panel.style.display = "none";
                btnIcon.className = "fa fa-angle-down";
                card.querySelector('.btn-detail').classList.remove('active');
            } else {
                // Đóng các panel khác cho gọn
                document.querySelectorAll('.detail-panel').forEach(p => p.style.display = 'none');
                document.querySelectorAll('.btn-detail').forEach(b => {
                    b.classList.remove('active');
                    b.querySelector('i').className = "fa fa-angle-down";
                });

                panel.style.display = "block";
                btnIcon.className = "fa fa-angle-up";
                card.querySelector('.btn-detail').classList.add('active');
            }
        }

        // 3. Edit Mode Logic
        function enableEdit(id) {
            const card = document.getElementById(`order-${id}`);
            card.classList.add('editing');
        }

        function cancelEdit(id) {
            const card = document.getElementById(`order-${id}`);
            card.classList.remove('editing');
        }

        // 4. Update Status AJAX
        function updateStatus(id, status) {
            const msg = status === 6 ? 'Bạn có chắc muốn HỦY đơn hàng này?' : 'Cập nhật trạng thái đơn hàng?';
            if (!confirm(msg)) return;

            fetch('/Admin/Orders/UpdateStatus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orderId: id, newStatus: status })
            })
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        alert("Cập nhật thành công!");
                        location.reload();
                    } else {
                        alert("Lỗi cập nhật!");
                    }
                })
                .catch(e => alert("Lỗi kết nối server"));
        }

        // 5. Remove Product AJAX
        function removeProduct(orderId, productId) {
            if (!confirm('Xóa sản phẩm này khỏi đơn hàng? Tổng tiền sẽ được tính lại.')) return;

            fetch('/Admin/Orders/RemoveProduct', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orderId: orderId, productId: productId })
            })
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        // Xóa visual ngay lập tức
                        document.getElementById(`item-${orderId}-${productId}`).remove();
                    } else {
                        alert("Không thể xóa sản phẩm cuối cùng!");
                    }
                });
        }
    </script>
}